# Energy Monitoring System

## Описание
- EMS - это клиент-серверное приложение для мониторинга и координорования приборов учёта электроэнергии, связанных между собой в сеть ZigBee при помощи радиомодулей. Связь между модулями этой системы, для удобства, изобразил на схеме ниже, данный проект включает в себя поддержу обмена на уровлях 1 и 2, а уровни 3 и 4 реализованы отдельно.
```
┌──────────┐                                  ┌─────────┐                  ┌──────┐     ┌──────┐
│ Клиент 1 │<─────┐                    ┌─────>│ Коорд 1 │<──────────┬─────>│ РМ 1 │<───>│ ПУ 1 │
└──────────┘      │                    │      └─────────┘           │      └──────┘     └──────┘
┌──────────┐      │    ┌──────────┐    │      ┌─────────┐           │      ┌──────┐     ┌──────┐
│ Клиент 2 │<─────┼───>│  Сервер  │<───┼─────>│ Коорд 2 │<──> ...   ├─────>│ РМ 2 │<───>│ ПУ 2 │
└──────────┘      │    └──────────┘    │      └─────────┘           │      └──────┘     └──────┘
    ...           ┆                    ┆         ...                ┆         ...          ...     
┌──────────┐      │                    │      ┌─────────┐           │      ┌──────┐     ┌──────┐
│ Клиент n │<─────┘                    └─────>│ Коорд g │<──> ...   └─────>│ РМ j │<───>│ ПУ k │
└──────────┘                                  └─────────┘                  └──────┘     └──────┘
                 ^                        ^                       ^                  ^          
                 │                        │                       │                  │          
            ┌┄┄┄┄┴┄┄┄┄┐              ┌┄┄┄┄┴┄┄┄┄┐          ┌┄┄┄┄┄┄┄┴┄┄┄┄┄┄┄┐    ┌┄┄┄┄┄┴┄┄┄┄┄┐    
            ┆   http  ┆              ┆   uart  ┆          ┆  zigbee/pirs  ┆    ┆ uart/dlms ┆    
            └┄┄┄ 1 ┄┄┄┘              └┄┄┄ 2 ┄┄┄┘          └┄┄┄┄┄┄ 3 ┄┄┄┄┄┄┘    └┄┄┄┄ 4 ┄┄┄┄┘    
```
- Между клиентами и сервером обмен происходит http-запросами/ответами по инициативе клиента, следуя rest-api. Между сервером и координаторами обмен совершается через serial-port по формату, который будет описан ниже. Сообщения от координатора к другим радиомодулям в сети переправляются по воздуху по протаколам ZigBee, сообщения в полезной нагрузке в вормате ПИРС. Долее радиомодуль общается с прибором учёта по протоколу DLMS (СПОДЕС).
- Исхордный код сервера можно найти в [/server/src/](/server/src/), а клиента - [/client/src/](/clientr/src/). Конфигурации сервера вынесены в файл [config.properties](server/src/main/resources/config/config.properties), а логи пишутся раздельно в три файла: с информацией, предупреждениями и ошибками в директорию [/logs/](/logs/).
- Также в разделе [/server/src/main/resources/database/](/server/src/main/resources/database/) лежат sql-скрипты под _PostgreSQL_ и под _MySQL_. В файле [RELEASE_NOTES.md](./RELEASE_NOTES.md) ведётся changelog.
 
## Формат сообщений координатора
### `Формат команд`
| Назначение | Заголовок (0xAA 0x01) | Код | Длина полезной нагрузки | Полезная нагрузка | Контрольная сумма |
| :---: | :---: | :---: | :---: | :---: | :---: |
| Длина, байт | 2 | 1 | 1 | n | 1 |
## `Команды`
| № | Код | Назначение | Параметры запроса \[длина\] | Параметры ответа \[длина\] | Нужна перезагрузка? |
| :---: | :---: | :---: | :--- | :--- | :---: |
| 1 | 0x00 | Открытие сессии |- | 1. \[1\] Результат | - |
| 2 | 0x01 | Установка кастомного MAC-адреса узлу | <br>1. \[8\] Адрес узла<br/> <br>2. \[8\] Новый адрес<br/> | 1. \[1\] Результат | - |
| 3 | 0x05 | Изгнание узла из сети | 1. \[8\] Адрес узла | 1. \[1\] Результат | - |
| 4 | 0x06 | Перезагрузка узла | 1. \[8\] Адрес узла | 1. \[1\] Результат | - |
| 5 | 0x07 | Получение списка активных узлов в сети | - | <br>Для каждого активного узла:<br/> <br>1. \[8\] Адрес узла<br/> <br>2. \[2\] Короткий адрес<br/> <br>3. \[1\] Тип<br/> <br>4. \[1\] RSSI<br/> <br>5. \[1\] LQI<br/> | - |
| 6 | 0x08 | Разрешить/запретить подключение новых узлов | 1. \[1\] Разрешить/запретить | 1. \[1\] Результат | - |
| 7 | 0x09 | Получение основной информации о сети | - | <br>1. \[1\] Номер канала<br/> <br>2. \[2\] Короткий адрес сети<br/> <br>3. \[8\] Длинный адрес сети<br/> <br>4. \[1\] Статус<br/> | - |
| 8 | 0x0B | Пересоздание сети на случайном канале | - | 1. \[1\] Результат | + |
| 9 | 0x0C | Получение перечня подключавшихся к сети узлов | - | <br>Для каждого узла:<br/> <br>1. \[8\] Адрес узла<br/> <br>2. \[1\] Статус (0x03)<br/> | - |
| 10 | 0x19 | Получение версии прошивки узла | 1. \[8\] Адрес узла | <br>1. \[8\] Адрес узла<br/> <br>2. \[22\] Версия<br/> | - |
| 11 | 0x1A | Загрузка обновления для узла | - | 1. \[1\] Результат | - |
| 12 | 0x1B | Отправка обновления узлу | 1. \[8\] Адрес узла | 1. \[1\] Результат | - |
| 13 | 0x23 | Пересоздание сети на заданном канале | 1. \[1\] Номер канала | 1. \[1\] Результат | + |
| 14 | 0xФ2 | Получения карты мартрутов в сети | - | <br>1. \[2\] Адрес узла<br/> <br>2. \[2\] Адрес следующего хопа<br/> <br>3. \[1\] Статус<br/> <br>4. \[1\] LQI<br/> <br>5. \[1\] Глубина<br/> | - |
| 15 | 0xAB | Отправка ПИРС-запросов на прибор учёта | 1. \[n\] ПИРС-запрос | 1. \[n\] ПИРС-ответ | - |
| 16 | 0xDB | Установка отладочного режима узла | <br>1. \[8\] Адрес узла<br/> <br>2. \[1\] Тип отладки<br/> <br>3. \[1\] Уровень отладки<br/> | 1. \[1\] Результат | - |
| 17 | 0xFF | Закрытие сессии | - | 1. \[1\] Результат | - |

## HTTP-Эндпоинты
1. __Запросы аунтификации пользователя:__
- _/api/auth/login_ - запрос на автаризацию пользователя;
- _/api/auth/logout_ - запрас на деавтаризацию пользователя;
- _/api/auth/register_ - запрос на регистрацию пользователя;
- _/api/auth/change-password_ - запрос на изменения пароля пользователя;
- _/api/auth/validate_ - запрос на проверку валидна ли текущая сессия взаимодействия с сервером;
- _/api/auth/profile_ - запрос на получение информации о текущем пользователе;
2. __Запросы о координаторах:__
- _/api/coordinators_ - запрос на получение информации о всех координаторах, которые принадлежат текущему пользователю;
- _/api/coordinators/n_ - запрос на получение информации о координаторе и его приборах учёта, где n - id координатора;
- _/api/coordinators/n/connect_ - запрос на проверку подключения между сервером и координатором, где n - id координатора;
- _/api/coordinators/n/command_ - запрос с командой на координатор, где n - id координатора;
3. __Запросы о приборах учёта:__
- /api/meters/n - запрос текущих показаний прибора учёта, где n - id прибора.

## База-данных
Приложение изпользует СУБД _PostgreSQL_, но в разделе [/server/src/main/resources/database/](/server/src/main/resources/database/) лежат sql-скрипты под _PostgreSQL_ и под _MySQL_. БД включает в себя таблицы _users_, _coordinators_, _meters_ и _logs_ (сейчас не используется).

### `users`
Таблица включает в себя информацию о пользователе
| Поле        | Тип            | Описание                                                |
|-------------|----------------|---------------------------------------------------------|
| `id`        | `INT`          | Уникальный идентификатор пользователя (__primary key__) |
| `login`     | `VARCHAR(128)` | Имя пользователя, также уникален                      |
| `password`  | `VARCHAR(256)` | Хэш пароля пользователя                                 |
| `is_active` | `SMALLINT`     | Флаг того, автаризован ли сейчас пользователь           |

### `coordinators`
Таблица включает в себя информацию о координаторах
| Поле         | Тип            | Описание                                                                                    |
|--------------|----------------|---------------------------------------------------------------------------------------------|
| `id`         | `INT`          | Уникальный идентификатор координатора (__primary key__)                                     |
| `user_id`    | `INT`          | Идентификатор пользователя, которому координатор принадлежит (связь с таблицей `users`)     |
| `name`       | `VARCHAR(128)` | Название сети (координаторы)                                                                |
| `mac`        | `VARCHAR(16)`  | MAC-адрес координатора                                                                      |
| `ip`         | `VARCHAR(15)`  | IP-адрес координатора (__не обязательный параметр__)                                        |
| `port`       | `SMALLINT`     | port координатора (__не обязательный параметр__)                                            |
| `status`     | `VARCHAR(10)`  | Текущий статус координаторы ('_online_', '_offline_' или '_error_')                         |
| `created_at` | `TIMESTAMP`    | Дата и время создания координатора                                                          |
| `last_seen`  | `TIMESTAMP`    | Дата и время последнего обращения к координатору                                            |

### `meters`
Таблица включает в себя информацию о приборах учёта.
| Поле              | Тип             | Описание                                                                                  |
|-------------------|-----------------|-------------------------------------------------------------------------------------------|
| `id`              | `INT`           | Уникальный идентификатор прибора учёта (__primary key__)                                  |
| `coordinator_id`  | `INT`           | Идентификатор координатора, которому прибор принадлежит (связь с таблицей `coordinators`) |
| `zb_long_addr`    | `VARCHAR(23)`   | Короткий ZigBee-адрес радиомодуля со стороны прибора учёта                                |
| `zb_short_addr`   | `SMALLINT`      | Длинный ZigBee-адрес радиомодуля со стороны прибора учёта                                 |
| `name`            | `VARCHAR(128)`  | Название прибора                                                                          |
| `status`          | `VARCHAR(10)`   | Текущий статус координаторы ('_online_', '_offline_' или '_error_')                       |
| `created_at`      | `TIMESTAMP`     | Дата и время создания прибора учёта                                                       |
| `last_seen`       | `TIMESTAMP`     | Дата и время последнего обращения к прибору учёта                                         |
| `voltage`         | `DECIMAL(10,2)` | Показание напряжения тока (__не обязательный параметр__)                                  |
| `current`         | `DECIMAL(10,2)` | Показание силы тока (__не обязательный параметр__)                                        |
| `active_power`    | `DECIMAL(10,2)` | Показание активной мощности (__не обязательный параметр__)                                |
| `reactive_power`  | `DECIMAL(10,2)` | Показание реактивной мощности (__не обязательный параметр__)                              |
| `apparent_power`  | `DECIMAL(10,2)` | Показание общей мощности (__не обязательный параметр__)                                   |
| `power_factor`    | `DECIMAL(10,2)` | Показание коэффициента мощности (__не обязательный параметр__)                            |
| `frequency`       | `DECIMAL(10,2)` | Показание частоты тока (__не обязательный параметр__)                                     |
| `neutral_current` | `DECIMAL(10,2)` | Показание тока на нулевом проводе (__не обязательный параметр__)                          |

### `logs`
Таблица включает в себя журналы устройств в сети (сейчас таблица не используется)
| Поле             | Тип           | Описание                                                                               |
|------------------|---------------|----------------------------------------------------------------------------------------|
| `id`             | `INT`         | Уникальный идентификатор лога (__primary key__)                                        |
| `coordinator_id` | `INT`         | Идентификатор координатора, которому принадлежит лог (связь с таблицей `coordinators`) |
| `meter_id`       | `INT`         | Идентификатор координатора, которому принадлежит лог (связь с таблицей `meters`)       |
| `type`           | `VARCHAR(10)` | Тип сообщения ('_info_', '_warning_' или '_error_')                                    |
| `message`        | `TEXT`        | Сообщение                                                                              |
| `timestamp`      | `TIMESTAMP`   | Время отправки сообщения                                                               |

## Структура проекта
Структыка исходного кода проекта и преднозначения модулей
```
├┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┤СЕРВЕР├┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄
│
├───server
│   ├───src
│   │   └───main
│   │       ├───java
│   │       │   └───com
│   │       │       └───energy
│   │       │           └───monitoring
│   │       │               ├───components
│   │       │               │       CoordinatorCommands.java   - Константные значения для формирования команд координаторам
│   │       │               │       DataBaseFildNames.java     - Константные значения имён полей таблиц базы данных
│   │       │               │       HttpConstructions.java     - Константные значения для кусочков HTTP-сообщений
│   │       │               │       HttpStatusCodes.java       - Статус-коды HTTP-ответов
│   │       │               │       JsonResponses.java         - Методы для формирования тел http-ответов в формате json
│   │       │               │       SqlRequests.java           - Константные конструкции sql-запросов
│   │       │               ├───config
│   │       │               │       Config.java                - Конфигурационные параметры проекта
│   │       │               │       ConfigKeys.java            - Ключи конфигурационных параметров
│   │       │               ├───controllers
│   │       │               │       AuthController.java        - Клаасс метадов обработки запросов аунтификации
│   │       │               │       CoordinatorController.java - Клаасс метадов обработки запросов координаторам
│   │       │               │       MeterController.java       - Клаасс метадов обработки запросов приборам учёта
│   │       │               ├───database
│   │       │               │   └───dao
│   │       │               │           BaseDAO.java           - Методы установки соединения с базой данных
│   │       │               │           CoordinatorDAO.java    - Методы для взаимодействия с таблицей координаторов
│   │       │               │           MeterDAO.java          - Методы для взаимодействия с таблицей приборов учёта
│   │       │               │           UserDAO.java           - Методы для взаимодействия с таблицей пользователей
│   │       │               │       JDBC.java                  - API для общения с базой данных
│   │       │               ├───controllers
│   │       │               │       HttpHandler.java           - Главный класс обработки http-запросов
│   │       │               ├───models
│   │       │               │       Coordinator.java           - Класс координатора
│   │       │               │       HttpRequest.java           - Класс http-запроса
│   │       │               │       HttpResponse.java          - Класс http-ответа
│   │       │               │       Meter.java                 - Класс прибора учёта
│   │       │               │       User.java                  - Класс пользователя
│   │       │               └───utils
│   │       │                       CommandsUtil.java          - Инструменты для работы с сообщениями координатора
│   │       │                       CrcUtil.java               - Инструменты для подсчёта контрольной суммы типа CRC-8/SMBUS
│   │       │                       JwtUtil.java               - Инструменты для работы с JWT-токенами
│   │       │                       PasswordHasher.java        - Инструменты для хеширования паролей
│   │       │                       UartUtil.java              - Инструменты для взаимодействия с координаторами по uart
│   │       │                   Server.java                    - Основные методы работы с сервером
│   │       └───resources
│   │           ├───config
│   │           │       config.properties                      - Конфиг-файл сервера
│   │           └───database
│   │                   energy_monitoring_database_mysql.sql   - sql-скрипт для MySQL
│   │                   energy_monitoring_database.sql         - sql-скрипт для PosgreSQL
│   │               logback.xml                                - Конфиг для потока логов
│   ├───logs
│   │       energy-monitoring-server-error.log                 - Журнал сообщений об ошибках
│   │       energy-monitoring-server-info.log                  - Журнал информационных сообщений
│   │       energy-monitoring-server-warn.log                  - Журнал сообщений о предупреждениях
│   └───target
│       └─── ...
│       pom.xml
│
├┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┤КЛИЕНТ├┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄
│
└───client
    └───src
        ├───assets
        │   └───images
        │       └───ems_icon.ico             - Иконка клиента
        ├───css
        │       auth.css                     - Стили для экрана авторизации
        │       base.css                     - Базовые стили и сброс
        │       components.css               - Стили для компонентов
        │       coordinators.css             - Стили для координаторов и приборов учёта
        │       layout.css                   - Стили основного приложения
        │       responsive.css               - Адаптивные стили
        │       style.css                    - Основной файл стилей
        │       variables.css                - Переменные и цвета
        └───js
            ├───api
            │       coordinator_api.js       - Инструменты для работы с координаторами
            │       meter_api.js             - Инструменты для работы с приборах учёта
            │       request_api.js           - Инструменты для работы с сервером energy_monitoring
            │       user_api.js              - Инструменты для авторизации пользователя
            └───handlers
                    auth_handler.js          - Класс с методами обработки процессов автаризации
                    coordinator_handler.js   - Класс с методами обработки действий с координаторами
                    meter_handler.js         - Класс с методами обработки действий со счётчиками
                    route_table_handler.js   - Класс с методами для отрисовки графа топологии сети
                    ui_handler.js            - Класс с меторами обработки графического интерфейса
                page_handler.js              - Основные методы для обработки страницы
            index.html                       - Разметка страницы
```
